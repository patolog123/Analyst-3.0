# Модель данных «AI-индексатор артефактов»

> Минимально достаточная схема под сценарии: присвоение меток (c AI-рекомендациями) и фильтрация по меткам. Без сценариев регистрации/оплаты/работы с файлами, поиска, навигации и push-уведомлений. Лимиты: до 10 меток на артефакт, фильтрация до 5 меток одновременно; обработка сбоя/таймаута AI и предупреждение при низкой уверенности.

---

## Объект User (Пользователь)
> Пользователь уже существует (нет сценариев регистрации/логина); используется для аудита действий.

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| username | String | Отображаемое имя | |
| role | Enum('analyst','admin') | Роль в системе | Default='analyst' |
| is_active | Boolean | Активен ли пользователь | Default=True |
| created_at | DateTime | Дата создания записи | Default=CURRENT_TIMESTAMP |

---

## Объект Project (Проект)
> Контекст хранения артефактов и настроек (лимиты вынесены сюда для простоты MVP).

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| name | String | Название проекта | Not Null, Unique |
| description | Text | Описание | |
| max_labels_per_artifact | Integer | Лимит меток на артефакт | Default=10 |
| max_filter_tags | Integer | Лимит меток в фильтре | Default=5 |
| ai_conf_threshold | Decimal(3,2) | Порог уверенности AI (0–1) | Default=0.80 |
| min_recommended_labels | Integer | Мин. рекомендуемых меток | Default=2 |
| created_at | DateTime | Дата создания | Default=CURRENT_TIMESTAMP |

---

## Объект Artifact (Артефакт)
> Текстовые записи и/или их метаданные (без загрузки файлов в MVP).

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| project_id | Integer | FK → Project.id | Not Null |
| external_id | String | Внешний ID/код | |
| type | Enum('text','meta') | Тип артефакта | Default='text' |
| title | String | Заголовок | |
| content | Text | Содержимое текста/описание | |
| created_by_user_id | Integer | FK → User.id | |
| created_at | DateTime | Когда создан | Default=CURRENT_TIMESTAMP |
| updated_at | DateTime | Когда обновлён | |

---

## Объект Tag (Метка)
> Справочник проектных меток.

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| project_id | Integer | FK → Project.id | Not Null |
| name | String | Отображаемое имя (без `#`) | Not Null |
| normalized_name | String | Нормализованное имя | Not Null, Unique(project_id, normalized_name) |
| description | String | Описание | |
| is_active | Boolean | Активность | Default=True |
| created_at | DateTime | Когда создана | Default=CURRENT_TIMESTAMP |

---

## Объект ArtifactTag (Присвоенная метка)
> Связь артефакт ↔ метка, включая источник (ручной/AI). Используется для фильтрации.

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| artifact_id | Integer | FK → Artifact.id | Not Null |
| tag_id | Integer | FK → Tag.id | Not Null |
| source | Enum('manual','ai_accepted') | Источник присвоения | Not Null |
| assigned_by_user_id | Integer | FK → User.id | |
| assigned_at | DateTime | Когда присвоено | Default=CURRENT_TIMESTAMP |
| уникальность |  | Одна активная связь | Unique(artifact_id, tag_id) |

---

## Объект LabelingSession (Сессия присвоения)
> Контекст кнопки «Присвоить метки»: снимок лимитов и участник сессии. Нужен для рекомендаций и аудита.

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| project_id | Integer | FK → Project.id | Not Null |
| user_id | Integer | FK → User.id | Not Null |
| selected_count | Integer | Сколько артефактов выбрано | Not Null |
| ai_conf_threshold | Decimal(3,2) | Снимок порога из Project | |
| min_recommended_labels | Integer | Снимок минимума из Project | |
| started_at | DateTime | Старт сессии | Default=CURRENT_TIMESTAMP |
| finished_at | DateTime | Завершение | |

---

## Объект AIRecommendation (Рекомендация AI)
> Кандидатные метки от AI для артефакта с
уверенностью и решением аналитика (принять/отклонить). При сохранении принятые превращаются в ArtifactTag.

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| session_id | Integer | FK → LabelingSession.id | Not Null |
| artifact_id | Integer | FK → Artifact.id | Not Null |
| suggested_tag_name | String | Предложенная метка (сырой текст) | Not Null |
| mapped_tag_id | Integer | FK → Tag.id (если сопоставлена) | |
| confidence | Decimal(3,2) | Уверенность (0–1) | Not Null |
| explanation | Text | Краткое пояснение модели | |
| decision | Enum('accepted','rejected','undecided') | Решение аналитика | Default='undecided' |
| decided_by_user_id | Integer | FK → User.id | |
| decided_at | DateTime | Когда принято решение | |
| created_at | DateTime | Когда предложено | Default=CURRENT_TIMESTAMP |
| уникальность |  | Нет дублей в сессии | Unique(session_id, artifact_id, suggested_tag_name) |

---

## (Опционально) Объект FilterQueryLog (Журнал фильтрации)
> Лёгкий лог: какие метки выбраны и сколько найдено (помогает UX и метрикам).

| Атрибут | Тип | Описание | Ограничения |
|---|---|---|---|
| id | Integer | PK | Auto Increment |
| project_id | Integer | FK → Project.id | Not Null |
| user_id | Integer | FK → User.id | Not Null |
| tag_ids | JSON | Список выбранных меток | Not Null |
| result_count | Integer | Результатов найдено | |
| created_at | DateTime | Когда выполнено | Default=CURRENT_TIMESTAMP |

---

## Бизнес-правила

1. Лимиты
   - На один артефакт можно назначить ≤ Project.max_labels_per_artifact (по умолчанию **10**).
   - В фильтре одновременно ≤ Project.max_filter_tags (по умолчанию **5**).

2. Рекомендации AI
   - 0 ≤ confidence ≤ 1.
   - Если число рекомендаций < min_recommended_labels и confidence < ai_conf_threshold, UI показывает предупреждение и предлагает ручной ввод меток.

3. Метки и уникальность
   - Unique(project_id, normalized_name) в Tag.
   - В ArtifactTag запрещены дубли: Unique(artifact_id, tag_id).
   - В AIRecommendation нет дублей в пределах session_id`+`artifact_id по suggested_tag_name.

4. Целостность сессии
   - finished_at ≥ started_at (если заполнено).
   - selected_count ≥ 1.

5. Фильтрация
   - Возвращаются артефакты, у которых есть все выбранные метки (AND-семантика).

6. Отказоустойчивость AI
   - При ошибке/таймауте AI (например, >5 c) — показать сообщение и разрешить ручной ввод; сохранение продолжимо без AI.

---

## Связи (Relations)

- Project 1 → ∞ Artifact, Tag, LabelingSession, (опц.) FilterQueryLog.  
- User 1 → ∞ LabelingSession, ArtifactTag (assigned_by), (опц.) FilterQueryLog.  
- Artifact ∞ → ∞ Tag через ArtifactTag.  
- LabelingSession 1 → ∞ AIRecommendation.  
- AIRecommendation 0..1 → 1 Tag (через `mapped_tag_id`).
