@startuml
actor "Пользователь" as User
participant "Телеграм-бот" as Bot
participant "Сервер Телеграм" as Telegram
participant "Бэк энд" as Backend
participant "База данных PG" as DB
participant "LLM (ГигаЧат)" as LLM

autonumber

== Активация уведомлений ==

User -> Bot : Нажимает "Активировать уведомления"
activate Bot

Bot -> Telegram : Отправляет команду активации
activate Telegram

Telegram -> Backend : /activate_notifications
activate Backend

Backend -> DB : Запрос списка предприятий и типов событий
activate DB

DB --> Backend : Возвращает список вариантов
deactivate DB

Backend --> Telegram : Отправляет варианты выбора
deactivate Backend

Telegram --> Bot : Передает список для отображения
deactivate Telegram

Bot --> User : Показывает список предприятий и типов событий
deactivate Bot

== Выбор критериев ==

User -> Bot : Выбирает предприятие и тип событий
activate Bot

Bot -> Telegram : Отправляет выбранные критерии
activate Telegram

Telegram -> Backend : /set_preferences
activate Backend

Backend -> DB : Сохраняет настройки пользователя
activate DB

DB --> Backend : Подтверждение сохранения
deactivate DB

Backend --> Telegram : Подтверждение успешного сохранения
deactivate Backend

Telegram --> Bot : Уведомление об успешной настройке
deactivate Telegram

Bot --> User : Подтверждение активации уведомлений
deactivate Bot

== Цикл проверки событий ==

loop Каждые 5 секунд
    Backend -> LLM : Запрос новостей/событий по критериям
    activate LLM
    
    LLM --> Backend : Возвращает результаты проверки
    deactivate LLM
    
    alt Найдены новые события
        activate Backend
        Backend -> Backend : Форматирует сообщение (2-3 предложения)
        
        Backend -> Telegram : Отправляет уведомление
        activate Telegram
        
        Telegram --> Bot : Передает сообщение
        activate Bot
        
        Bot --> User : Показывает уведомление
        deactivate Bot
        deactivate Telegram
        
        Backend -> DB : Сохраняет в журнал событий
        activate DB
        
        DB --> Backend : Подтверждение сохранения
        deactivate DB
        deactivate Backend
    end
end

center footer
<b>Таблица описания шагов</b>
| № | Описание шага |
| 1 | Пользователь нажимает кнопку активации уведомлений |
| 2 | Бот отправляет команду активации на сервер Телеграм |
| 3 | Сервер Телеграм делает HTTP-запрос к бэкенду |
| 4 | Бэкенд выполняет SQL-запрос к базе данных |
| 5 | База данных возвращает список предприятий и типов событий |
| 6 | Бэкенд отправляет варианты выбора на сервер Телеграм |
| 7 | Сервер Телеграм передает список боту |
| 8 | Бот отображает список пользователю |
| 9 | Пользователь выбирает предприятия и типы событий |
| 10 | Бот отправляет выбранные критерии на сервер Телеграм |
| 11 | Сервер Телеграм делает HTTP-запрос с настройками |
| 12 | Бэкенд сохраняет настройки пользователя в БД |
| 13 | БД подтверждает сохранение настроек |
| 14 | Бэкенд подтверждает успешное сохранение |
| 15 | Сервер Телеграм передает подтверждение боту |
| 16 | Бот на экране уведомляет пользователя об активации |
| 17 | Бэкенд запрашивает новости/события у LLM по выбранным пользователем предприятиям и типам событий/новостей |
| 18 | LLM возвращает результаты проверки в виде полного текста события/новости |
| 19 | Бэкенд форматирует сообщение (до 2-3 предложений) |
| 20 | Бэкенд отправляет уведомление о получении новых событий/новостей на сервер Телеграм |
| 21 | Сервер Телеграм передает уведомление боту |
| 22 | Бот показывает уведомление пользователю на экране |
| 23 | Бэкенд сохраняет событие/новость в журнал БД |
| 24 | БД подтверждает сохранение события/новости |
end footer

@enduml